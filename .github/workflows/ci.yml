name: CI/CD Pipeline

on:
  push:
  pull_request:

jobs:
  backend-build:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build backend with Maven
        working-directory: backend/todo
        run: ./mvnw clean install -DskipTests

  frontend-build:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: backend-build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/todo/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: frontend/todo
        run: npm ci
      
      - name: Build frontend
        working-directory: frontend/todo
        run: npm run build

  backend-tests:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    needs: frontend-build
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: todo_ris
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Wait for MySQL to be ready
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 --silent; do
            echo 'Waiting for MySQL...'
            sleep 2
          done
      
      - name: Initialize database
        run: |
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password < sql_setup.sql
      
      - name: Run backend tests
        working-directory: backend/todo
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/todo_ris
          SPRING_DATASOURCE_USERNAME: todo_backend
          SPRING_DATASOURCE_PASSWORD: geslo123
        run: ./mvnw test
